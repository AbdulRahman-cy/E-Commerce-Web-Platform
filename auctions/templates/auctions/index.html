{% extends "auctions/layout.html" %}
{% load auction_tags %}

{% block body %}

<style>
.listing-card {
    border: 1px solid rgba(0,0,0,.08);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    transition: box-shadow .2s;
    cursor: pointer;
}

.listing-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
}

.listing-image {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
}

.price {
    color: #059669;
    font-weight: 600;
}

.meta {
    font-size: 0.9rem;
    color: #6b7280;
}

/* Like button styles */
.like-btn {
    outline: none;
    background: none;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
    margin-top: 10px;
}

.like-btn:hover {
    outline: none;
    border-color: #ef4444;
    color: #ef4444;
}

.like-btn.liked {
    outline: none;
    background: #ef4444;
    border-color: #ef4444;
    color: white;
}

.watchlist-btn {
    outline: none;
    background: none;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
    margin-top: 10px;
    margin-left: 6px;
}

.watchlist-btn:hover {
    border-color: #f59e0b;
    color: #f59e0b;
}

.watchlist-btn.added {
    background: #f59e0b;
    border-color: #f59e0b;
    color: white;
}

.cart-btn {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    background: #0d6efd;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    margin-top: 7px;
}

.cart-btn:hover {
    background: #0b5ed7;
}

.cart-btn:disabled {
    background: #adb5bd;
    cursor: not-allowed;
}

.cart-btn.in-cart {
    background: #198754;
}

/* Cart Controls Container */
[id^="cart-controls-"] {
    display: inline-flex;
    align-items: center;
    gap: 20px;
    margin-top: 8px;
}

.qty-btn-decrease,
.qty-btn-increase {
    width: 30px;
    height: 30px;
    border: 2px solid #0d6efd;
    border-radius: 50%;
    background: white;
    color: #0d6efd;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    padding: 0;
}

.qty-btn-decrease:hover,
.qty-btn-increase:hover {
    background: #0d6efd;
    color: white;
}

[id^="qty-"] {
    font-weight: bold;
    width: 20px;
    text-align: center;
}


</style>

<h2 class="mb-4">Active listings</h2>

<div class="row">

    {% for listing in listings %}
        <div class="col-md-4">

            <div class="listing-card" data-listing-id="{{listing.id}}">

                {% if listing.image_url %}
                    <img src="{{ listing.image_url }}"
                         class="listing-image mb-3"
                         alt="{{ listing.title }}">
                {% else %}
                    <div class="listing-image mb-3 d-flex align-items-center justify-content-center bg-light">
                        <span class="text-muted">No image</span>
                    </div>
                {% endif %}

                <h5>{{ listing.title }}</h5>

                <p class="price mb-1">
                    ${{ listing.starting_price }}
                </p>

                <p class="meta mb-1">
                    Listed by {{ listing.owner.username }}
                </p>

                <p class="meta mb-2">
                    {{ listing.created_at|date:"M d, Y" }}
                </p>

                {# Like button - check if current user has already liked this #}
                <button class="like-btn {% if listing in liked_listings %}liked{% endif %}"
                    data-listing-id="{{ listing.id }}" data-like-url="{% url 'toggle_like' listing.id%}">
                    ‚ù§Ô∏è <span class="like-count">{{ listing.likes.count }}</span> 
                    <span class="like-text"> likes </span>
                </button>
                
                <form action="{% url 'watchlist_toggle' %}" method="POST" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="listing" value="{{ listing.id }}">

                    <button type="submit"
                            class="watchlist-btn {% if listing in watchlist %}added{% endif %}">
                        ‚≠ê {% if listing in watchlist %}Remove from watchlist{% else %}Add to watchlist{% endif %}
                    </button>
                </form>

                <!--Add to cart button-->
                <button class="cart-btn {% if listing in cart %}in-cart{% endif %}" 
                data-listing-id="{{ listing.id }}" type="button" data-cart-url="{% url 'toggle_cart' listing.id %}">
                    {% if listing in cart %}Remove from cart{% else %}üõí Add to cart{% endif %}
                </button>

                <!-- "+" "-" controls-->
                <div id="cart-controls-{{listing.id}}" data-listing-id="{{listing.id}}" >
                    {% if listing in cart %}
                        <button class="qty-btn-decrease" data-cart-url="{% url 'toggle_cart' listing.id %}" data-listing-id="{{ listing.id }}">‚àí</button>
                            <span id="qty-{{listing.id}}">{{ cart_map|get_item:listing.id }}</span>
                        <button class="qty-btn-increase" data-cart-url="{% url 'toggle_cart' listing.id %}" data-listing-id="{{ listing.id }}">+</button>
                    {% endif %}
                </div>

            </div>
        </div>
    {% empty %}
        <div class="col">
            <p>No active listings.</p>
        </div>
    {% endfor %}
</div>


<script>
    
    //Copied from django's docummentation
    function getCookie(name){
        let cookieValue = null;
        if(document.cookie && document.cookie !== null){
            const cookies = document.cookie.split(';');
            for(let i = 0; i < cookies.length; i++){
                const cookie = cookies[i].trim()
                if(cookie.substring(0, name.length + 1) === (name + '=')){
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    
    document.addEventListener('DOMContentLoaded', function() {
        //Ajax like
        document.querySelectorAll('.like-btn').forEach(function(button) {
            button.addEventListener('click', async function(event){
                event.preventDefault();
                const listingId = button.dataset.listingId;
                const url = this.dataset.likeUrl;
                const csrftoken = getCookie('csrftoken');

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({})
                    });
                    
                    const data = await response.json();

                    const likeCount = button.querySelector('.like-count');
                    likeCount.textContent = data.count;

                    if (data.liked) {
                        button.classList.add('liked');
                    } else {
                        button.classList.remove('liked');
            }
                }
                catch(error) {
                    console.error('Error:', error);
                    alert('Failed to update like');
                }
                
                
            });
        });
        //Selectable card
        const cards = document.querySelectorAll('.listing-card')
        cards.forEach(function(card) {
            card.addEventListener('click', function(event){
                //This needs to be changed
                if(event.target.closest('.like-btn') || 
                   event.target.closest('.cart-btn') ||
                   event.target.closest('.watchlist-btn') ||
                   event.target.closest('.qty-btn-decrease') ||
                   event.target.closest('.qty-btn-increase')
                ){
                    return;
                }

                const listingId = card.dataset.listingId;
                window.location.href = `/listing/${listingId}`;
            });
        });
        
        //Ajax add to cart button
        document.querySelectorAll('.cart-btn').forEach(function(cart){
            cart.addEventListener('click', async function() {
                const listingId = this.dataset.listingId;
                const csrftoken = getCookie('csrftoken');
                const cartButton = document.getElementById('cartButton');
                const url = cart.dataset.cartUrl;

                try{
                    response = await fetch(url, {
                    method : "POST",
                    headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({})
                    });
                    const data = await response.json();
                    //Then modify it here for realtime change
                    window.updateCartUI(data.cart_count, data.in_cart, cart, listingId, data.item_quantity);
                }
                catch(error){
                    console.error('Error:', error);
                    alert('Failed to add to cart');
                }

            });
        });

        //If "-"
        document.querySelectorAll('.qty-btn-decrease').forEach(function(btn){
            btn.addEventListener('click', async function(){
                const action = 'decrease';
                const listingId = btn.dataset.listingId;
                const csrftoken = getCookie('csrftoken');
                const url = this.dataset.cartUrl;
                const cartBtn = document.querySelector(`.cart-btn[data-listing-id="${listingId}"]`);
                try{
                    const response = await fetch(url, {
                    method : "POST",
                    headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({action})
                    });
                    const data = await response.json();
                    //Then modify it here for realtime change
                    window.updateCartUI(data.cart_count, data.in_cart, cartBtn, listingId, data.item_quantity);
                    }
                    catch(error){
                        console.error('Error:', error);
                        alert('Failed to add to cart');
                    }
            });

        });

        //If "+"
        document.querySelectorAll('.qty-btn-increase').forEach(function(btn){
            btn.addEventListener('click', async function(){
                const action = 'increase';
                const listingId = btn.dataset.listingId;
                const csrftoken = getCookie('csrftoken');
                const url = this.dataset.cartUrl;
                const cartBtn = document.querySelector(`.cart-btn[data-listing-id="${listingId}"]`);
                try{
                    const response = await fetch(url, {
                    method : "POST",
                    headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({action})
                    });
                    const data = await response.json();
                    //Then modify it here for realtime change
                    window.updateCartUI(data.cart_count, data.in_cart, cartBtn, listingId, data.item_quantity);
                    }
                    catch(error){
                        console.error('Error:', error);
                        alert('Failed to add to cart');
                    }
            });

        });
    });
</script>

{% endblock %}
