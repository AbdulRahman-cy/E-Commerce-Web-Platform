{% extends "auctions/layout.html" %}
{% block body %}

<style>
.like-btn {
    outline: none;
    background: none;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
    margin-top: 10px;
}

.like-btn:hover {
    outline: none;
    border-color: #ef4444;
    color: #ef4444;
}

.like-btn.liked {
    outline: none;
    background: #ef4444;
    border-color: #ef4444;
    color: white;
}
.watchlist-btn {
    outline: none;
    background: none;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
    margin-top: 10px;
    margin-left: 6px;
}

.watchlist-btn:hover {
    border-color: #f59e0b;
    color: #f59e0b;
}

.watchlist-btn.added {
    background: #f59e0b;
    border-color: #f59e0b;
    color: white;
}

.cart-btn {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    background: #0d6efd;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    margin-top: 7px;
}

.cart-btn:hover {
    background: #0b5ed7;
}

.cart-btn:disabled {
    background: #adb5bd;
    cursor: not-allowed;
}

.cart-btn.in-cart {
    background: #198754;
}

</style>
<div class="container my-5">

  <div class="card shadow-sm mb-4">
    <div class="row g-0">

      <!-- image side -->
      <div class="col-md-6">
        {% if listing.image_url %}
          <img src="{{ listing.image_url }}" class="img-fluid h-100 w-100 object-fit-cover rounded-start">
        {% else %}
          <div class="d-flex align-items-center justify-content-center h-100 bg-light">
            <span class="text-muted">No image</span>
          </div>
        {% endif %}
      </div>

      <!-- details side -->
      <div class="col-md-6">
        <div class="card-body d-flex flex-column h-100">

          <h3 class="card-title">{{ listing.title }}</h3>
          <p class="text-muted mb-1">
            By {{ listing.owner.username }}
          </p>

          <h4 class="text-success mt-2">
            ${{ listing.starting_price }}
          </h4>

          <span class="badge bg-primary mb-3">
            Active
          </span>

          <p class="card-text">
            {{ listing.description }}
          </p>

          <div class="mb-3">
            <span>
              üí¨ comments: {{comments_count}}
            </span>
          </div>

          <div class="mt-auto">

            <!-- ajax like_button-->
            <button class="like-btn {% if listing in liked_listings %}liked{% endif %}"
                data-listing-id="{{ listing.id }}">
                  ‚ù§Ô∏è <span class="like-count">{{ listing.likes.count }}</span> 
                <span class="like-text"> likes </span>
            </button>

            <form action="{% url 'watchlist_toggle' %}" method="POST" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="listing" value="{{ listing.id }}">

            <button type="submit"
                    class="watchlist-btn {% if listing in watchlist %}added{% endif %}">
                ‚≠ê {% if listing in watchlist %}Remove from watchlist{% else %}Add to watchlist{% endif %}
            </button>

            <button class="cart-btn {% if listing in cart %}in-cart{% endif %}" 
              data-listing-id="{{ listing.id }}" type="button" data-cart-url="{% url 'toggle_cart' listing.id %}">
                  {% if listing in cart %}Remove from cart{% else %}üõí Add to cart{% endif %}
              </button>
          </form>

          </div>
        </div>
      </div>
    </div>
  </div>
    <!-- comment form -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">

      <h5 class="mb-3">Add a comment</h5>

      <form action="{% url 'comment' listing.id %}" method="POST">
        {% csrf_token %}

        <div class="mb-3">
          <textarea
            name="comment"
            class="form-control"
            rows="4"
            placeholder="Write your comment..."
          ></textarea>
        </div>

        <button type="submit" class="btn btn-success">
          Submit
        </button>

      </form>
    </div>
  </div>


  <!-- comments -->
  <div>
    <h4 class="mb-3">Comments</h4>

    {% if comments %}
      {% for comment in comments %}
        <div class="card mb-2">
          <div class="card-body py-2">
            <strong>{{ comment.user.username }}</strong>
            <div class="text-muted small">
              {{ comment.content }}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">No comments yet.</p>
    {% endif %}
  </div>

</div>

<script>
  //Copied from django's docummentation
    function getCookie(name){
        let cookieValue = null;
        if(document.cookie && document.cookie !== null){
            const cookies = document.cookie.split(';');
            for(let i = 0; i < cookies.length; i++){
                const cookie = cookies[i].trim()
                if(cookie.substring(0, name.length + 1) === (name + '=')){
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    return cookieValue;
                    break;
                }
            }
        }
    }


  document.addEventListener('DOMContentLoaded', function(){
    const button = document.querySelector('.like-btn')
    if(!button){
      return;
    }
    button.addEventListener('click', async function(event){
      event.preventDefault();

      const listingId = button.dataset.listingId
      const csrftoken = getCookie('csrftoken');

      try {
        const response = await fetch(`/listing/${listingId}/like/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
        });
    
        const data = await response.json();

        const likeCount = button.querySelector('.like-count');
        likeCount.textContent = data.count;

        if (data.liked) {
          button.classList.add('liked');
        } 
        else {
          button.classList.remove('liked');
        }
    }
    catch(error) {
      console.error('Error:', error);
      alert('Failed to update like');
    }
    });
    cartBtn = document.querySelector('.cart-btn');
    cartBtn.addEventListener('click', async function() {
                const listingId = this.dataset.listingId;
                const csrftoken = getCookie('csrftoken');
                const cartButton = document.getElementById('cartButton');
                const url = this.dataset.cartUrl;
                try{
                    response = await fetch(url, {
                    method : "POST",
                    headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({})
                    });
                    const data = await response.json();
                    //Then modify it here for realtime change
                    window.updateCartUI(data.cart_count, data.in_cart, cartBtn);
                }
                catch(error){
                    console.error('Error:', error);
                    alert('Failed to add to cart');
                }

            });
        });
</script>

{% endblock %}

